<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpamLens ‚Äî Gmail Spam Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #060c18; --surface: rgba(255,255,255,0.025); --border: rgba(255,255,255,0.07);
  --accent: #0ea5e9; --accent2: #a78bfa; --text: #f1f5f9; --muted: #475569; --dim: #1e293b;
  --red: #f43f5e; --orange: #fb923c; --yellow: #fbbf24; --green: #22c55e;
  --mono: 'JetBrains Mono', monospace; --serif: 'Playfair Display', serif; --sans: 'DM Sans', system-ui, sans-serif;
}
html, body { height: 100%; }
body {
  background: var(--bg); color: var(--text); font-family: var(--sans); font-size: 14px; line-height: 1.5;
  background-image: radial-gradient(ellipse 70% 40% at 50% 0%, rgba(14,165,233,0.08), transparent 65%);
  min-height: 100vh;
}
nav {
  position: sticky; top: 0; z-index: 200; padding: 14px 32px;
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(6,12,24,0.9); backdrop-filter: blur(14px); border-bottom: 1px solid var(--border);
}
.nav-left { display: flex; align-items: center; gap: 10px; }
.nav-logo { font-family: var(--serif); font-size: 20px; font-weight: 800; }
.nav-badge {
  font-family: var(--mono); font-size: 9px; font-weight: 700; letter-spacing: 0.14em;
  color: var(--accent); padding: 2px 8px; border: 1px solid rgba(14,165,233,0.25);
  border-radius: 4px; background: rgba(14,165,233,0.07);
}
.btn-ghost {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  color: var(--muted); padding: 5px 14px; font-size: 12px; cursor: pointer;
  font-family: var(--mono); transition: all 0.15s;
}
.btn-ghost:hover { background: rgba(255,255,255,0.05); color: var(--text); }

/* SETUP */
#setup-screen { max-width: 560px; margin: 52px auto; padding: 0 24px; }
.setup-hero { text-align: center; margin-bottom: 32px; }
.setup-icon {
  width: 68px; height: 68px; border-radius: 20px; margin: 0 auto 18px;
  background: linear-gradient(135deg, #0c1928, #112d4a); border: 1px solid rgba(14,165,233,0.22);
  display: flex; align-items: center; justify-content: center; font-size: 28px;
}
.setup-title { font-family: var(--serif); font-size: 28px; font-weight: 800; margin-bottom: 10px; }
.setup-sub { color: var(--muted); font-size: 14px; line-height: 1.75; }
.card { background: rgba(14,165,233,0.045); border: 1px solid rgba(14,165,233,0.16); border-radius: 20px; padding: 24px; margin-bottom: 14px; }
.card-title { font-family: var(--serif); font-size: 15px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.card-sub { color: var(--muted); font-size: 13px; line-height: 1.65; margin-bottom: 16px; }
input[type=text] {
  width: 100%; background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px; padding: 11px 15px; color: var(--text); font-size: 13px;
  font-family: var(--mono); outline: none; margin-bottom: 12px; transition: border-color 0.15s;
}
input:focus { border-color: rgba(14,165,233,0.4); }
.btn-primary {
  width: 100%; padding: 12px; border-radius: 12px; border: none;
  background: linear-gradient(135deg, #0ea5e9, #0369a1); color: #fff;
  font-size: 14px; font-weight: 700; cursor: pointer; font-family: var(--mono);
  letter-spacing: 0.05em; transition: opacity 0.15s;
}
.btn-primary:disabled { background: rgba(255,255,255,0.05); color: #1f2937; cursor: default; }
.btn-primary:not(:disabled):hover { opacity: 0.88; }
.error-box { background: rgba(244,63,94,0.08); border: 1px solid rgba(244,63,94,0.22); border-radius: 10px; padding: 10px 14px; color: #fda4af; font-size: 13px; margin-bottom: 12px; }
.info-box { background: rgba(14,165,233,0.07); border: 1px solid rgba(14,165,233,0.18); border-radius: 10px; padding: 10px 14px; color: #7dd3fc; font-size: 13px; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { display: inline-block; width: 11px; height: 11px; border: 2px solid rgba(14,165,233,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }

/* STEPS */
.steps-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
.steps-btn { width: 100%; padding: 13px 18px; background: none; border: none; color: var(--muted); font-size: 13px; cursor: pointer; text-align: left; display: flex; justify-content: space-between; font-family: var(--mono); }
.steps-body { display: none; padding: 4px 18px 20px; border-top: 1px solid rgba(255,255,255,0.04); }
.steps-body.open { display: block; }
.step { display: flex; gap: 11px; margin-top: 13px; align-items: flex-start; }
.step-n { width: 19px; height: 19px; border-radius: 50%; background: rgba(14,165,233,0.1); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; margin-top: 2px; font-family: var(--mono); }
.step-text { font-size: 13px; color: #64748b; line-height: 1.65; }
.step-text a { color: var(--accent); text-decoration: none; font-family: var(--mono); font-size: 12px; }
.step-text code { color: var(--accent2); font-size: 12px; background: rgba(167,139,250,0.1); padding: 1px 6px; border-radius: 4px; font-family: var(--mono); }
.tip-box { margin-top: 16px; padding: 10px 12px; background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.12); border-radius: 10px; font-size: 12px; color: #4b5563; }

/* LOADING */
#loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 65vh; gap: 18px; }
.big-spinner { width: 52px; height: 52px; border: 3px solid rgba(14,165,233,0.15); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.85s linear infinite; }
#loading-msg { color: var(--accent); font-family: var(--mono); font-size: 14px; }

/* DASHBOARD */
#dashboard { padding: 24px 28px; max-width: 1320px; margin: 0 auto; }
.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 17px 20px; }
.stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.12em; font-family: var(--mono); margin-bottom: 6px; }
.stat-value { font-size: 32px; font-weight: 800; font-family: var(--serif); line-height: 1.1; }
.stat-sub { font-size: 11px; color: var(--dim); margin-top: 4px; }
.insights-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.insight-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 13px; padding: 14px 15px; }
.insight-header { display: flex; align-items: center; gap: 7px; margin-bottom: 7px; }
.insight-title { font-size: 11px; font-weight: 700; font-family: var(--mono); }
.insight-body { font-size: 11px; color: var(--muted); line-height: 1.65; }
.charts-2col { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px; }
.charts-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.panel { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 22px; margin-bottom: 16px; }
.panel-title { font-family: var(--serif); font-size: 14px; font-weight: 700; color: #94a3b8; margin-bottom: 16px; }
#keyword-cloud { display: flex; flex-wrap: wrap; gap: 7px; }
.kw-tag { font-family: var(--mono); padding: 4px 10px; border-radius: 6px; cursor: default; }
.feed-filters { display: flex; gap: 7px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
.filter-btn { padding: 4px 12px; border-radius: 20px; border: 1px solid; font-size: 11px; font-family: var(--mono); cursor: pointer; font-weight: 700; background: transparent; transition: all 0.15s; }
.feed-search { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; padding: 4px 12px; color: var(--text); font-size: 12px; font-family: var(--mono); outline: none; width: 140px; }
#email-list { display: flex; flex-direction: column; gap: 3px; max-height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.08) transparent; }
.email-row { display: flex; align-items: center; gap: 10px; padding: 8px 11px; background: rgba(255,255,255,0.015); border-radius: 9px; border: 1px solid rgba(255,255,255,0.04); }
.email-cat { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; font-family: var(--mono); white-space: nowrap; }
.email-subject { font-size: 13px; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.email-from { font-size: 11px; color: var(--dim); font-family: var(--mono); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.email-date { font-size: 10px; color: #111827; font-family: var(--mono); white-space: nowrap; }
.email-info { flex: 1; min-width: 0; }
.pie-legend { display: flex; flex-direction: column; gap: 7px; margin-top: 10px; }
.pie-legend-row { display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
.pie-dot { width: 7px; height: 7px; border-radius: 2px; }
.pie-name { display: flex; align-items: center; gap: 6px; color: var(--muted); }
.hidden { display: none !important; }
@media (max-width: 900px) {
  .stats-grid { grid-template-columns: repeat(3,1fr); }
  .insights-grid { grid-template-columns: repeat(2,1fr); }
  .charts-2col, .charts-equal { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<nav>
  <div class="nav-left">
    <span style="font-size:18px">üî¨</span>
    <span class="nav-logo">SpamLens</span>
    <span class="nav-badge">GMAIL ANALYZER</span>
  </div>
  <div id="nav-right"></div>
</nav>

<!-- SETUP -->
<div id="setup-screen">
  <div class="setup-hero">
    <div class="setup-icon">üî¨</div>
    <h1 class="setup-title">SpamLens</h1>
    <p class="setup-sub">Analyze your Gmail spam ‚Äî volume trends, phishing detection, keyword patterns, and repeat offenders. Everything runs in your browser.</p>
  </div>

  <div class="card">
    <div class="card-title">üîê Connect with Google</div>
    <p class="card-sub">Enter your OAuth Client ID, then click the button. A Google sign-in window will open ‚Äî grant read-only Gmail access and you're in.</p>
    <input type="text" id="client-id-input" placeholder="123456789-abc.apps.googleusercontent.com" />
    <div id="error-box" class="error-box hidden"></div>
    <div id="info-box" class="info-box hidden"></div>
    <button class="btn-primary" id="connect-btn" onclick="startOAuth()">Sign in with Google ‚Üí</button>
  </div>

  <div class="steps-card">
    <button class="steps-btn" onclick="toggleSteps(this)">
      <span>üìã How to create your OAuth Client ID</span><span>‚ñº</span>
    </button>
    <div class="steps-body" id="steps-body">
      <div class="step"><div class="step-n">1</div>
        <div class="step-text">Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com ‚Üó</a> and create or select a project</div></div>
      <div class="step"><div class="step-n">2</div>
        <div class="step-text">Go to <b>APIs &amp; Services ‚Üí Library</b>, search for <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank">Gmail API ‚Üó</a> and click <b>Enable</b></div></div>
      <div class="step"><div class="step-n">3</div>
        <div class="step-text">Go to <b>APIs &amp; Services ‚Üí OAuth consent screen</b> ‚Üí External ‚Üí fill in App name + your email ‚Üí add scope <code>gmail.readonly</code> ‚Üí Save</div></div>
      <div class="step"><div class="step-n">4</div>
        <div class="step-text">Go to <b>Credentials ‚Üí Create Credentials ‚Üí OAuth client ID</b> ‚Üí choose <b>Web application</b></div></div>
      <div class="step"><div class="step-n">5</div>
        <div class="step-text">Under <b>Authorized JavaScript origins</b> add: <code id="origin-hint">http://localhost:8080</code></div></div>
      <div class="step"><div class="step-n">6</div>
        <div class="step-text">Copy the Client ID (ends in <code>.apps.googleusercontent.com</code>) and paste it above</div></div>
      <div class="tip-box">üí° After saving credentials in Google Console, wait ~1 minute before trying ‚Äî changes take a moment to propagate.</div>
    </div>
  </div>
</div>

<!-- LOADING -->
<div id="loading-screen" class="hidden">
  <div class="big-spinner"></div>
  <div id="loading-msg">Fetching spam‚Ä¶</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <div class="stats-grid" id="stats-grid"></div>
  <div class="insights-grid" id="insights-grid"></div>
  <div class="charts-2col">
    <div class="panel"><div class="panel-title">üìà Spam Volume ‚Äî Weekly</div><canvas id="chart-timeline"></canvas></div>
    <div class="panel"><div class="panel-title">üéØ Category Breakdown</div><canvas id="chart-pie" height="150"></canvas><div class="pie-legend" id="pie-legend"></div></div>
  </div>
  <div class="charts-equal">
    <div class="panel"><div class="panel-title">üë§ Top Spam Domains</div><canvas id="chart-domains" height="240"></canvas></div>
    <div class="panel"><div class="panel-title">üîë Subject Line Keywords</div><div id="keyword-cloud"></div></div>
  </div>
  <div class="panel" id="monthly-panel"><div class="panel-title">üìÖ Monthly Volume</div><canvas id="chart-monthly" height="160"></canvas></div>
  <div class="panel">
    <div class="panel-title">üìã All Spam Messages</div>
    <div class="feed-filters" id="feed-filters"></div>
    <input class="feed-search" type="text" placeholder="Search‚Ä¶" oninput="filterFeed(this.value)">
    <div id="email-list"></div>
    <div id="feed-count" style="font-size:11px;color:#1f2937;text-align:center;margin-top:8px;font-family:monospace"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_COLORS = { Phishing:'#f43f5e', Scam:'#fb923c', Promotional:'#38bdf8', Newsletter:'#a78bfa', Other:'#6b7280' };
const URGENCY = ['urgent','act now','final','last chance','limited time','expires','warning','verify','suspended',
  'compromised','unusual','alert','immediately','click here','confirm','winner','congratulations','claim','free',
  'prize','offer','discount','deal','sale','save','exclusive','selected','password','account','cancelled',
  'expire','update','payment','invoice','refund','delivery','tracking'];
const PHISHING = ['verify','account','password','suspended','unusual login','sign-in','billing','payment',
  'expired','compromised','confirm your','action required'];
const SCAM     = ['winner','lottery','prize','claim','million','inheritance','work from home','make money',
  'no experience','investment','bitcoin','crypto','guaranteed'];
const PROMO    = ['sale','discount','% off','deal','offer','coupon','free shipping','flash','members',
  'exclusive','savings','blowout','clearance','today only'];
const NEWS     = ['newsletter','weekly','digest','roundup','recap','edition'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allEmails = [], filteredEmails = [], activeCat = 'All', searchQ = '', charts = {};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('origin-hint').textContent = window.location.origin;

// Check if we're returning from OAuth redirect (token in URL hash)
(function checkOAuthReturn() {
  const hash = window.location.hash;
  if (!hash.includes('access_token')) return;
  const params = new URLSearchParams(hash.slice(1));
  const token = params.get('access_token');
  if (!token) return;
  // Clean URL
  history.replaceState(null, '', window.location.pathname);
  // Restore client ID if saved
  const savedId = sessionStorage.getItem('spamlens_client_id');
  if (savedId) document.getElementById('client-id-input').value = savedId;
  showOnly('loading-screen');
  runAnalysis(token);
})();

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showOnly(id) {
  ['setup-screen','loading-screen','dashboard'].forEach(s => {
    const el = document.getElementById(s);
    el.style.display = (s === id) ? '' : 'none';
    if (s === id) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });
}
function setMsg(msg) { document.getElementById('loading-msg').textContent = msg; }
function showErr(msg) {
  const b = document.getElementById('error-box'); b.textContent = '‚ö†Ô∏è ' + msg; b.classList.remove('hidden');
}
function showInfo(msg) {
  const b = document.getElementById('info-box'); b.textContent = msg; b.classList.remove('hidden');
}
function toggleSteps(btn) {
  const body = document.getElementById('steps-body');
  const open = body.classList.toggle('open');
  btn.querySelector('span:last-child').textContent = open ? '‚ñ≤' : '‚ñº';
}

// ‚îÄ‚îÄ OAUTH (implicit / token flow ‚Äî no GIS script needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startOAuth() {
  const clientId = document.getElementById('client-id-input').value.trim();
  if (!clientId) { showErr('Please enter your OAuth Client ID.'); return; }
  document.getElementById('error-box').classList.add('hidden');
  document.getElementById('info-box').classList.add('hidden');

  sessionStorage.setItem('spamlens_client_id', clientId);

  const params = new URLSearchParams({
    client_id:     clientId,
    redirect_uri:  window.location.origin + window.location.pathname,
    response_type: 'token',
    scope:         'https://www.googleapis.com/auth/gmail.readonly',
    include_granted_scopes: 'true',
    prompt: 'consent',
  });
  window.location.href = 'https://accounts.google.com/o/oauth2/v2/auth?' + params.toString();
}

// ‚îÄ‚îÄ GMAIL API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function gmailGet(path, token, params = {}) {
  const url = new URL('https://gmail.googleapis.com/gmail/v1' + path);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err?.error?.message || 'Gmail API error ' + res.status);
  }
  return res.json();
}

async function fetchSpam(token) {
  setMsg('Listing spam messages‚Ä¶');
  const list = await gmailGet('/users/me/messages', token, { labelIds:'SPAM', maxResults:200 });
  const msgs = list.messages || [];
  if (!msgs.length) return [];
  const BATCH = 25;
  const out = [];
  for (let i = 0; i < msgs.length; i += BATCH) {
    setMsg(`Fetching ${Math.min(i+BATCH, msgs.length)} / ${msgs.length} messages‚Ä¶`);
    const batch = await Promise.all(
      msgs.slice(i,i+BATCH).map(m => gmailGet('/users/me/messages/'+m.id, token, {
        format: 'metadata', metadataHeaders: 'From,Subject,Date',
      }))
    );
    out.push(...batch);
  }
  return out.map(parseMsg).filter(Boolean);
}

function parseMsg(msg) {
  const h = {};
  (msg.payload?.headers||[]).forEach(x => { h[x.name.toLowerCase()] = x.value; });
  const date = new Date(h['date'] || (msg.internalDate ? +msg.internalDate : Date.now()));
  if (isNaN(date)) return null;
  const from    = h['from']    || 'unknown';
  const subject = h['subject'] || '(no subject)';
  const combo   = (subject+' '+from).toLowerCase();
  const em = from.match(/<(.+?)>/) || from.match(/([^\s]+@[^\s]+)/);
  const email  = em ? em[1].replace(/[<>]/g,'').trim() : from.trim();
  const domain = email.split('@')[1] || 'unknown';
  let cat = 'Other';
  if (PHISHING.some(s=>combo.includes(s)))    cat = 'Phishing';
  else if (SCAM.some(s=>combo.includes(s)))   cat = 'Scam';
  else if (NEWS.some(s=>combo.includes(s)))   cat = 'Newsletter';
  else if (PROMO.some(s=>combo.includes(s)))  cat = 'Promotional';
  const keywords = URGENCY.filter(w=>combo.includes(w));
  return { id:msg.id, from:email, domain, subject, date, cat, keywords };
}

async function runAnalysis(token) {
  try {
    setMsg('Signed in! Fetching spam‚Ä¶');
    const emails = await fetchSpam(token);
    if (!emails.length) {
      showOnly('setup-screen');
      showErr('No spam messages found. Your spam folder may be empty.');
      return;
    }
    allEmails = emails;
    renderDashboard(emails);
    showOnly('dashboard');
  } catch(e) {
    console.error(e);
    showOnly('setup-screen');
    showErr(e.message || 'Failed to fetch data from Gmail.');
  }
}

// ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function analyze(emails) {
  const wkMap={}, moMap={}, catMap={}, domMap={}, snMap={}, kwMap={};
  emails.forEach(e => {
    const wk = e.date.toLocaleString('default',{month:'short',year:'2-digit'})+' W'+Math.ceil(e.date.getDate()/7);
    wkMap[wk] = wkMap[wk] || {week:wk,count:0,ts:e.date.getTime()}; wkMap[wk].count++;
    const mo = e.date.toLocaleString('default',{month:'short',year:'numeric'});
    moMap[mo] = moMap[mo] || {month:mo,count:0,ts:new Date(e.date.getFullYear(),e.date.getMonth()).getTime()}; moMap[mo].count++;
    catMap[e.cat]  = (catMap[e.cat]||0)+1;
    domMap[e.domain] = (domMap[e.domain]||0)+1;
    snMap[e.from]  = snMap[e.from]  || {from:e.from,domain:e.domain,count:0}; snMap[e.from].count++;
    e.keywords.forEach(k=>{ kwMap[k]=(kwMap[k]||0)+1; });
  });
  const timeline  = Object.values(wkMap).sort((a,b)=>a.ts-b.ts);
  const monthly   = Object.values(moMap).sort((a,b)=>a.ts-b.ts);
  const categories = Object.entries(catMap).map(([n,v])=>({name:n,value:v})).sort((a,b)=>b.value-a.value);
  const topDomains = Object.entries(domMap).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([n,c])=>({name:n,count:c}));
  const topSenders = Object.values(snMap).sort((a,b)=>b.count-a.count);
  const topKw = Object.entries(kwMap).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([w,c])=>({word:w,count:c}));
  const total=emails.length, uniq=Object.keys(snMap).length;
  const phish=catMap['Phishing']||0, scam=catMap['Scam']||0;
  const recent=timeline[timeline.length-1]?.count||0, prev=timeline[timeline.length-2]?.count||0;
  const delta=prev?Math.round((recent-prev)/prev*100):0;
  const urgRatio=Math.round(emails.filter(e=>e.keywords.length>=2).length/total*100);
  const top=topSenders[0];
  const insights=[
    {icon:delta>=0?'üìà':'üìâ',color:delta>=0?'#f43f5e':'#22c55e',
     title:delta>=0?`Spam up ${delta}% this week`:`Spam down ${Math.abs(delta)}% this week`,
     body:`Most recent week: ${recent} vs ${prev} the week before.`},
    {icon:'üé£',color:'#f43f5e',title:`${phish} phishing attempt${phish!==1?'s':''}`,
     body:phish>0?'These tried to steal credentials. Never click their links.':'No phishing detected in this batch.'},
    top&&{icon:'üîÅ',color:'#fb923c',title:'Top repeat offender',
     body:`${top.domain} sent ${top.count} emails (${Math.round(top.count/total*100)}% of total). Consider blocking it.`},
    {icon:'‚ö°',color:'#fbbf24',title:`${urgRatio}% use urgency tactics`,
     body:`${urgRatio}% of spam uses 2+ pressure words like "final", "act now", or "verify".`},
  ].filter(Boolean);
  return {timeline,monthly,categories,topDomains,topKw,insights,stats:{total,uniq,phish,scam,urgRatio}};
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard(emails) {
  const d = analyze(emails);

  // nav
  document.getElementById('nav-right').innerHTML =
    `<span style="font-size:11px;color:#1f2937;font-family:monospace;margin-right:12px">${emails.length} messages</span>
     <button class="btn-ghost" onclick="doDisconnect()">‚Üê Sign out</button>`;

  // stats
  document.getElementById('stats-grid').innerHTML = [
    {label:'Total Spam',value:d.stats.total,sub:'messages analyzed',color:'#f1f5f9'},
    {label:'Phishing',value:d.stats.phish,sub:'credential attacks',color:'#f43f5e'},
    {label:'Scams',value:d.stats.scam,sub:'fraudulent offers',color:'#fb923c'},
    {label:'Unique Senders',value:d.stats.uniq,sub:'distinct addresses',color:'#38bdf8'},
    {label:'Urgency Tactics',value:d.stats.urgRatio+'%',sub:'use pressure words',color:'#fbbf24'},
  ].map(s=>`<div class="stat-card">
    <div class="stat-label">${s.label}</div>
    <div class="stat-value" style="color:${s.color}">${s.value}</div>
    <div class="stat-sub">${s.sub}</div>
  </div>`).join('');

  // insights
  document.getElementById('insights-grid').innerHTML = d.insights.map(i=>`
    <div class="insight-card" style="border-left:3px solid ${i.color}">
      <div class="insight-header"><span style="font-size:14px">${i.icon}</span>
        <span class="insight-title" style="color:${i.color}">${i.title}</span></div>
      <div class="insight-body">${i.body}</div>
    </div>`).join('');

  // destroy old charts
  Object.values(charts).forEach(c=>c.destroy()); charts={};

  const cOpts = (yAxis=true) => ({
    responsive:true,
    plugins:{legend:{display:false},tooltip:{backgroundColor:'#0b1120',borderColor:'rgba(255,255,255,0.1)',
      borderWidth:1,titleColor:'#475569',bodyColor:'#38bdf8',bodyFont:{family:'JetBrains Mono, monospace'}}},
    scales:{
      x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#374151',font:{family:'JetBrains Mono, monospace',size:10}},border:{display:false}},
      y:{display:yAxis,grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#374151',font:{size:10}},border:{display:false}},
    }
  });

  // timeline
  charts.tl = new Chart(document.getElementById('chart-timeline'),{
    type:'line',
    data:{labels:d.timeline.map(x=>x.week),datasets:[{data:d.timeline.map(x=>x.count),
      borderColor:'#0ea5e9',borderWidth:2,backgroundColor:'rgba(14,165,233,0.08)',
      pointBackgroundColor:'#0ea5e9',pointRadius:3,tension:0.35,fill:true}]},
    options:cOpts(true),
  });

  // pie
  const pieC = d.categories.map(c=>CAT_COLORS[c.name]||'#6b7280');
  charts.pie = new Chart(document.getElementById('chart-pie'),{
    type:'doughnut',
    data:{labels:d.categories.map(c=>c.name),datasets:[{data:d.categories.map(c=>c.value),backgroundColor:pieC,borderWidth:0}]},
    options:{responsive:true,cutout:'62%',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.raw}`}}}},
  });
  document.getElementById('pie-legend').innerHTML = d.categories.map((c,i)=>`
    <div class="pie-legend-row">
      <div class="pie-name"><div class="pie-dot" style="background:${pieC[i]}"></div><span>${c.name}</span></div>
      <span style="color:#111827;font-family:monospace;font-weight:700">${c.value}</span>
    </div>`).join('');

  // domains
  const dRev = [...d.topDomains].reverse();
  charts.dom = new Chart(document.getElementById('chart-domains'),{
    type:'bar',
    data:{labels:dRev.map(x=>x.name),datasets:[{data:dRev.map(x=>x.count),backgroundColor:'rgba(14,165,233,0.75)',borderRadius:4}]},
    options:{...cOpts(false),indexAxis:'y'},
  });

  // monthly
  if (d.monthly.length>1){
    document.getElementById('monthly-panel').style.display='';
    charts.mo = new Chart(document.getElementById('chart-monthly'),{
      type:'bar',
      data:{labels:d.monthly.map(x=>x.month),datasets:[{data:d.monthly.map(x=>x.count),backgroundColor:'rgba(167,139,250,0.7)',borderRadius:4}]},
      options:cOpts(true),
    });
  } else {
    document.getElementById('monthly-panel').style.display='none';
  }

  // keywords
  const kc = document.getElementById('keyword-cloud'); kc.innerHTML='';
  const maxK = Math.max(...d.topKw.map(k=>k.count),1);
  d.topKw.forEach(({word,count})=>{
    const r=count/maxK, size=11+r*8, op=0.3+r*0.7;
    const sp = document.createElement('span');
    sp.className='kw-tag';
    sp.style.cssText=`font-size:${size}px;color:rgba(56,189,248,${op});background:rgba(14,165,233,${0.04+r*0.1});border:1px solid rgba(14,165,233,${0.07+r*0.2});font-weight:${r>0.5?700:400}`;
    sp.textContent=word;
    const b=document.createElement('span');
    b.textContent=count; b.style.cssText='font-size:9px;color:#1f2937;margin-left:4px';
    sp.appendChild(b); kc.appendChild(sp);
  });

  // feed filters
  const ff=document.getElementById('feed-filters'); ff.innerHTML='';
  ['All',...Object.keys(CAT_COLORS)].forEach(cat=>{
    const b=document.createElement('button'); b.className='filter-btn'; b.textContent=cat; b.dataset.cat=cat;
    updateBtnStyle(b, cat==='All', cat);
    b.onclick=()=>{ activeCat=cat; applyFilter(); document.querySelectorAll('.filter-btn').forEach(x=>updateBtnStyle(x,x.dataset.cat===cat,x.dataset.cat)); };
    ff.appendChild(b);
  });

  filteredEmails=emails; renderList();
}

function updateBtnStyle(btn, active, cat) {
  const color = CAT_COLORS[cat]||'#38bdf8';
  btn.style.borderColor = active ? color : 'rgba(255,255,255,0.07)';
  btn.style.background  = active ? color+'20' : 'transparent';
  btn.style.color       = active ? color : '#374151';
}

function filterFeed(q) { searchQ=q.toLowerCase(); applyFilter(); }
function applyFilter() {
  filteredEmails = allEmails
    .filter(e=>activeCat==='All'||e.cat===activeCat)
    .filter(e=>!searchQ||e.subject.toLowerCase().includes(searchQ)||e.from.toLowerCase().includes(searchQ));
  renderList();
}
function renderList() {
  const list=document.getElementById('email-list'), shown=filteredEmails.slice(0,80);
  list.innerHTML='';
  if(!shown.length){list.innerHTML='<div style="color:#1f2937;text-align:center;padding:24px;font-size:13px">No messages match.</div>'; return;}
  shown.forEach(e=>{
    const color=CAT_COLORS[e.cat]||'#6b7280';
    const row=document.createElement('div'); row.className='email-row';
    row.innerHTML=`<span class="email-cat" style="background:${color}20;color:${color}">${e.cat.toUpperCase()}</span>
      <div class="email-info">
        <div class="email-subject">${esc(e.subject)}</div>
        <div class="email-from">${esc(e.from)}</div>
      </div>
      <span class="email-date">${e.date.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>`;
    list.appendChild(row);
  });
  document.getElementById('feed-count').textContent = filteredEmails.length>80?`Showing 80 of ${filteredEmails.length}`:'';
}

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function doDisconnect(){ allEmails=[]; Object.values(charts).forEach(c=>c.destroy()); charts={}; document.getElementById('nav-right').innerHTML=''; showOnly('setup-screen'); }
showOnly('setup-screen');
</script>
</body>
</html>
